<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DreamPlay – Membership NFT Claim</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;margin:0;background:#0b0f14;color:#e7edf3}
    .wrap{max-width:720px;margin:32px auto;padding:16px}
    .card{background:#121821;border:1px solid #1b2531;border-radius:14px;padding:20px;margin-bottom:16px}
    h1{margin:0 0 8px;font-size:24px}
    input,button{width:100%;padding:12px;border-radius:10px;border:1px solid #263244;background:#0d131a;color:#e7edf3}
    button{cursor:pointer;background:#0ea5e9;border-color:#0ea5e9;font-weight:700}
    .small{font-size:12px;color:#9ab0c4}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .ok{color:#22c55e}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    a{color:#93c5fd}
  </style>
  <!-- Ethers v6 UMD -->
  <script defer src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Claim your Membership NFT</h1>
      <p class="small">Paste your <strong>purchase transaction hash</strong> from Polygonscan, connect the same wallet used to buy, then mint.</p>

      <div class="row" style="margin-top:10px">
        <button id="btnConnect" style="flex:0 0 200px">Connect Wallet</button>
        <div id="acct" class="small mono"></div>
      </div>

      <div style="margin-top:12px">
        <input id="txHash" placeholder="0x… (your purchase transaction hash)"/>
      </div>

      <div style="margin-top:12px">
        <button id="btnVerify">Verify & Claim NFT</button>
      </div>

      <div id="status" class="small" style="margin-top:10px"></div>

      <div class="small" style="margin-top:10px">
        Store: <a target="_blank" rel="noreferrer" class="mono" href="https://polygonscan.com/address/0x94617689Ca2F39C5418Bd3CF143445d5533af489">0x9461…f489</a> ·
        Membership: <a target="_blank" rel="noreferrer" class="mono" href="https://polygonscan.com/address/0x9d9605e6924bA7a0411dd381e0eE8000da129316">0x9d96…9316</a>
      </div>
    </div>
  </div>

<script>
"use strict";
(async function(){
  // ======== Config ========
  const MEMBERSHIP_CONTRACT = "0x9d9605e6924bA7a0411dd381e0eE8000da129316"; // DreamPlayMembershipNFT
  // Use absolute URLs to avoid routing/caching issues:
  const SIGN_ENDPOINTS = [
    "https://dreamplay-claim-portal.netlify.app/api/sign-claim",
    "https://dreamplay-claim-portal.netlify.app/.netlify/functions/sign-claim"
  ];
  const EXPLORER = "https://polygonscan.com";

  // Human-readable ABI (robust with ethers v6)
  const MEMBERSHIP_ABI = [
    "function claim(address to, uint8 tier, bytes32 orderHash, string tokenURI, uint8 v, bytes32 r, bytes32 s) returns (uint256 tokenId)"
  ];

  const $ = (id)=>document.getElementById(id);
  let provider, signer, acct;

  function setStatus(msg, ok=false){
    const el = $('status');
    el.innerHTML = ok ? '<span class="ok">'+msg+'</span>' : msg;
  }

  $('btnConnect').onclick = async ()=>{
    try{
      if (!window.ethereum){ setStatus("Please install MetaMask"); return; }
      provider = new ethers.BrowserProvider(window.ethereum, 'any');
      await provider.send('eth_requestAccounts',[]);
      signer = await provider.getSigner();
      acct = await signer.getAddress();
      $('acct').textContent = 'Connected: ' + acct;

      // Optional: warn if not on Polygon mainnet
      try {
        const net = await provider.getNetwork();
        if (Number(net.chainId) !== 137) {
          setStatus("Note: you are not on Polygon mainnet (chainId " + net.chainId + "). Switch to Polygon.", false);
        }
      } catch {}
    }catch(err){
      setStatus('❌ ' + (err?.message || String(err)));
    }
  };

  // Show server error details instead of just "400"
  async function requestSignature(payload){
    let lastErr;
    for (const url of SIGN_ENDPOINTS){
      try{
        const r = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload),
          cache:'no-store'
        });
        const text = await r.text();
        let data; try { data = JSON.parse(text); } catch { data = { raw:text }; }
        if (r.ok) return data;
        const detail = data && (data.error || data.detail || data.raw) || `HTTP ${r.status}`;
        lastErr = new Error(detail);
        lastErr.response = data;
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error('Signer unavailable');
  }

  $('btnVerify').onclick = async ()=>{
    try{
      if (!signer) await $('btnConnect').onclick();
      const txHash = $('txHash').value.trim();
      if (!txHash || !txHash.startsWith('0x') || txHash.length < 66) {
        throw new Error('Enter a valid transaction hash');
      }

      // --- Build tokenURI FIRST so server can include it in the EIP-712 signature ---
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'>
        <rect width='100%' height='100%' fill='#0b0f14'/>
        <text x='50%' y='48%' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='sans-serif' font-size='40'>DreamPlay Membership</text>
        <text x='50%' y='58%' dominant-baseline='middle' text-anchor='middle' fill='#9ab0c4' font-family='sans-serif' font-size='24'>Wallet ${acct.slice(0,6)}…${acct.slice(-4)}</text>
      </svg>`;
      const image = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
      const tokenURI = "data:application/json;utf8," + encodeURIComponent(JSON.stringify({
        name: "DreamPlay Membership",
        description: "Membership NFT",
        image,
        attributes: [{trait_type:"claim_method", value:"txhash_portal"}]
      }));

      setStatus("Verifying purchase & signing claim…");
      // Ask the server to verify txHash belongs to your store + buyer == connected wallet,
      // and to sign INCLUDING tokenURI (if your contract requires it).
      const sig = await requestSignature({ txHash, to: acct, tier: 0, tokenURI });
      const { v, r, s, orderHash, tier, tokenName, chainId, signerAddress, buyer, skuId, includeTokenURI } = sig;

      setStatus(`Verified. Debug:
• includeTokenURI: ${includeTokenURI}
• signerAddress: ${signerAddress}
• domain name: ${tokenName}
• chainId: ${chainId}
• tx buyer: ${buyer}
• skuId→tier: ${skuId}→${tier}
Submitting mint…`);

      // Mint
      const c = new ethers.Contract(MEMBERSHIP_CONTRACT, MEMBERSHIP_ABI, signer);
      if (typeof c.claim !== 'function') throw new Error('ABI mismatch: claim(...) not found');

      const tx = await c.claim(acct, (tier || 1), orderHash, tokenURI, v, r, s);
      const rcpt = await tx.wait();
      setStatus('Minted! <a class="mono" target="_blank" rel="noreferrer" href="'+EXPLORER+'/tx/'+rcpt.hash+'">'+rcpt.hash+'</a>', true);
    }catch(err){
      // If server provided structured error, show it nicely
      if (err && err.response && (err.response.error || err.response.buyer)) {
        const msg = [
          err.response.error ? `Error: ${err.response.error}` : '',
          err.response.buyer ? `Tx buyer: ${err.response.buyer}` : '',
          acct ? `Connected: ${acct}` : ''
        ].filter(Boolean).join('<br>');
        setStatus("❌ " + msg);
        return;
      }
      setStatus("❌ " + (err && err.message ? err.message : String(err)));
    }
  };
})();
</script>
</body>
</html>
