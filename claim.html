<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DreamPlay – Membership NFT Claim</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;margin:0;background:#0b0f14;color:#e7edf3}
    .wrap{max-width:880px;margin:32px auto;padding:16px}
    .card{background:#121821;border:1px solid #1b2531;border-radius:14px;padding:20px;margin-bottom:16px}
    h1{margin:0 0 8px;font-size:24px}
    label{display:block;font-size:12px;color:#9ab0c4;margin:10px 0 6px}
    input,button{width:100%;padding:12px;border-radius:10px;border:1px solid #263244;background:#0d131a;color:#e7edf3}
    button{cursor:pointer;background:#0ea5e9;border-color:#0ea5e9;font-weight:700}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .small{font-size:12px;color:#9ab0c4}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .ok{color:#22c55e}
    .bad{color:#f87171}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    a{color:#93c5fd}
    .preview{margin-top:14px;border:1px dashed #2a3646;border-radius:10px;padding:12px;display:none}
    .thumb{width:140px;height:140px;object-fit:cover;border-radius:12px;border:1px solid #243244;background:#0d131a}
    .flex{display:flex;gap:12px;align-items:flex-start}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .panel{margin-top:10px;border:1px solid #253244;border-radius:10px;padding:10px;background:#0d131a}
  </style>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230ea5e9'/%3E%3Ctext x='32' y='38' font-size='28' text-anchor='middle' fill='white' font-family='sans-serif'%3ED%3C/text%3E%3C/svg%3E">
  <!-- Ethers v6 (UMD) -->
  <script defer src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Claim your Membership NFT</h1>
      <p class="small">Paste your <strong>purchase transaction hash</strong> from Polygonscan, connect the same wallet used to buy, then mint. This version uses one image for all NFTs and no extra fields.</p>

      <div class="row" style="margin-top:10px">
        <button id="btnConnect" style="flex:0 0 200px" disabled>Connect Wallet</button>
        <div id="acct" class="small mono"></div>
      </div>

      <label for="txHash">Purchase transaction hash</label>
      <input id="txHash" placeholder="0x… (your purchase tx hash on Polygon)" />

      <div style="margin-top:12px">
        <button id="btnVerify" disabled>Verify & Claim NFT</button>
      </div>

      <div id="status" class="small" style="margin-top:10px"></div>

      <div id="debug" class="panel small" style="display:none">
        <div><strong>Details</strong></div>
        <div id="detailBuyer" class="mono"></div>
        <div id="detailSku" class="mono"></div>
        <div id="detailPreflight" class="mono"></div>
      </div>

      <div id="metaPreview" class="preview small"></div>

      <div class="small" style="margin-top:10px;opacity:.9">
        Store: <a target="_blank" rel="noreferrer" class="mono" href="https://polygonscan.com/address/0x94617689Ca2F39C5418Bd3CF143445d5533af489">0x9461…f489</a> ·
        Membership: <a target="_blank" rel="noreferrer" class="mono" href="https://polygonscan.com/address/0x9d9605e6924bA7a0411dd381e0eE8000da129316">0x9d96…9316</a>
      </div>
    </div>
  </div>

<script>
"use strict";

(function boot(){
  // Enable buttons ONLY after ethers has loaded and DOM is ready
  const readyInterval = setInterval(()=>{
    if (window.ethers && document.readyState !== "loading") {
      clearInterval(readyInterval);
      init();
    }
  }, 50);
})();

function init(){
  // ==== CONTRACTS (Polygon) ====
  const STORE_ADDR      = "0x94617689Ca2F39C5418Bd3CF143445d5533af489";
  const MEMBERSHIP_ADDR = "0x9d9605e6924bA7a0411dd381e0eE8000da129316";

  // Single image for all tokens
  const SINGLE_IMAGE_PATH = "/images/membership.png"; // ensure this exists

  // ==== ABIs ====
  const STORE_ABI = [
    "event Purchased(address indexed buyer,uint256 indexed skuId,uint256 priceUSDC,address sponsor,address[8] uplines,uint256[8] levelPaid,uint256 storehouseAmt,uint256 wipAmt)"
  ];
  const MEMBERSHIP_ABI = [
    "event Transfer(address indexed from, address indexed to, uint256 indexed tokenId)",
    "function claim(uint256 skuId, bytes32 fieldsHash) returns (uint256)"
  ];
  const MEMBERSHIP_IFACE = new ethers.Interface(MEMBERSHIP_ABI);

  const $ = (id)=>document.getElementById(id);
  const btnConnect = $('btnConnect');
  const btnVerify  = $('btnVerify');
  const statusEl   = $('status');

  let provider, signer, acct;

  function setStatus(msg, ok=false){
    statusEl.innerHTML = ok ? '<span class="ok">'+msg+'</span>' : msg;
  }
  function absUrl(p){ return p.startsWith("http") ? p : (location.origin + p); }

  function buildMetadata(skuId){
    const imageUrl = absUrl(SINGLE_IMAGE_PATH);
    return {
      name: "DreamPlay Membership",
      description: "DreamPlay Membership NFT. Claim verified by store purchase.",
      image: imageUrl,
      attributes: [{ trait_type: "skuId", value: String(skuId) }]
    };
  }

  function showPreview(metadata, tokenId=null){
    const box = $('metaPreview');
    const jsonPretty = JSON.stringify(metadata, null, 2);
    const metaDataURI = "data:application/json;utf8," + encodeURIComponent(jsonPretty);
    const openSea = tokenId ? `https://opensea.io/assets/matic/${MEMBERSHIP_ADDR}/${tokenId}` : null;
    box.style.display = 'block';
    box.innerHTML = `
      <div><strong>Metadata preview${tokenId?` for token #${tokenId}`:''}:</strong></div>
      <div class="flex" style="margin-top:8px">
        <img class="thumb" src="${metadata.image}" alt="NFT Image" onerror="this.src='${absUrl('/images/sku-default.png')}'">
        <div class="mono" style="white-space:pre-wrap;overflow:auto;max-height:260px">${jsonPretty}</div>
      </div>
      <div class="actions">
        <a download="metadata${tokenId?'-'+tokenId:''}.json" href="${metaDataURI}">Download metadata JSON</a>
        <button id="copyUriBtn" type="button">Copy tokenURI (data:)</button>
        ${openSea ? `<a target="_blank" rel="noreferrer" href="${openSea}">OpenSea</a>` : ""}
      </div>
    `;
    const btn = document.getElementById('copyUriBtn');
    if (btn) btn.onclick = async ()=>{
      const tokenURI = "data:application/json;utf8," + encodeURIComponent(jsonPretty);
      await navigator.clipboard.writeText(tokenURI);
      setStatus("tokenURI copied to clipboard.", true);
    };
  }

  function tryGetTokenIdFromReceipt(rcpt){
    try{
      const i = new ethers.Interface(MEMBERSHIP_ABI);
      for (const lg of rcpt.logs || []) {
        if ((lg.address || '').toLowerCase() !== MEMBERSHIP_ADDR.toLowerCase()) continue;
        try{
          const ev = i.parseLog(lg);
          if (ev && ev.name === 'Transfer') return ev.args.tokenId.toString();
        }catch{}
      }
    }catch{}
    return null;
  }

  // Enable Connect button and wire up
  btnConnect.disabled = false;
  btnConnect.onclick = async ()=>{
    try{
      if (!window.ethereum){
        setStatus('❌ MetaMask not detected. Install MetaMask and open this page in a standard browser (not an embedded webview).');
        return;
      }
      // Request accounts must be triggered by a user gesture
      provider = new ethers.BrowserProvider(window.ethereum, 'any');
      await provider.send('eth_requestAccounts', []);
      signer = await provider.getSigner();
      acct   = await signer.getAddress();
      $('acct').textContent = 'Connected: ' + acct;

      try {
        const net = await provider.getNetwork();
        if (Number(net.chainId) !== 137) {
          setStatus('Not on Polygon. MetaMask may prompt you to switch.', false);
          // attempt to switch (will prompt user)
          try{
            await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x89' }] });
            setStatus('Switched to Polygon.', true);
          }catch{}
        } else {
          setStatus('Wallet connected.', true);
        }
      } catch {}

      btnVerify.disabled = false;
    }catch(err){
      setStatus('❌ ' + (err?.message || String(err)));
    }
  };

  async function getPurchase(txHash){
    const r = await provider.getTransactionReceipt(txHash);
    if (!r || r.status !== 1) throw new Error("Invalid or failed transaction");
    const iface = new ethers.Interface(STORE_ABI);
    for (const lg of r.logs || []) {
      if ((lg.address || '').toLowerCase() !== STORE_ADDR.toLowerCase()) continue;
      try{
        const ev = iface.parseLog(lg);
        if (ev && ev.name === 'Purchased') {
          return { buyer: ev.args.buyer, skuId: Number(ev.args.skuId) };
        }
      }catch{}
    }
    throw new Error("No Purchased event found for this tx");
  }

  // Preflight using low-level call to claim(skuId,bytes32)
  async function preflightClaim(acct, skuId, fieldsHash){
    try{
      const data = MEMBERSHIP_IFACE.encodeFunctionData("claim", [skuId, fieldsHash]);
      await provider.call({ to: MEMBERSHIP_ADDR, from: acct, data });
      return { ok:true, message:"OK" };
    }catch(e){
      const msg = (e && e.message) ? e.message : String(e);
      return { ok:false, message: msg };
    }
  }

  btnVerify.onclick = async ()=>{
    $('debug').style.display = 'none';
    try{
      if (!signer) { setStatus('Please connect your wallet first.'); return; }
      const txHash = $('txHash').value.trim();
      if (!txHash || !txHash.startsWith('0x') || txHash.length < 66) throw new Error('Enter a valid transaction hash');

      setStatus("Checking purchase…");
      const { buyer, skuId } = await getPurchase(txHash);

      $('debug').style.display = 'block';
      $('detailBuyer').textContent = "Detected buyer (from tx): " + buyer;
      $('detailSku').textContent   = "Detected skuId: " + skuId;

      if (buyer.toLowerCase() !== acct.toLowerCase()) {
        $('detailPreflight').textContent = "Wallet mismatch";
        setStatus(`❌ Wallet mismatch. Tx buyer is ${buyer}, you connected ${acct}.`);
        return;
      }

      // Build & show metadata (single image, no fields)
      const metadata = buildMetadata(skuId);
      showPreview(metadata);

      // Constant fieldsHash
      const fieldsHash = ethers.keccak256(ethers.toUtf8Bytes("DP-MEMBERSHIP"));

      // Preflight
      const pre = await preflightClaim(acct, skuId, fieldsHash);
      $('detailPreflight').textContent = "Preflight: " + pre.message;

      if (!pre.ok){
        if (pre.message.toLowerCase().includes("already claimed")) {
          setStatus("Already claimed for this wallet/SKU.", false);
        } else {
          setStatus("❌ " + pre.message);
        }
        return;
      }

      // Mint
      setStatus(`Verified purchase for skuId ${skuId}. Minting…`);
      const membership = new ethers.Contract(MEMBERSHIP_ADDR, MEMBERSHIP_ABI, signer);
      const tx = await membership.claim(skuId, fieldsHash);
      const rcpt = await tx.wait();
      const tokenId = tryGetTokenIdFromReceipt(rcpt);

      setStatus(
        'Minted! <a class="mono" target="_blank" rel="noreferrer" href="https://polygonscan.com/tx/'+rcpt.hash+'">'+rcpt.hash+'</a>',
        true
      );
      showPreview(metadata, tokenId);

      // Best-effort tokenURI (owner-only on many contracts). If it fails, do manual setTokenURI on Polygonscan.
      try{
        const c2 = new ethers.Contract(MEMBERSHIP_ADDR, ["function setTokenURI(uint256,string)"], signer);
        if (typeof c2.setTokenURI === 'function' && tokenId !== null) {
          const tokenURI = "data:application/json;utf8," + encodeURIComponent(JSON.stringify(metadata));
          setStatus("Minted. Setting tokenURI…", true);
          const tx2 = await c2.setTokenURI(tokenId, tokenURI);
          await tx2.wait();
          setStatus(
            'Minted & tokenURI set! <a class="mono" target="_blank" rel="noreferrer" href="https://polygonscan.com/tx/'+tx2.hash+'">'+tx2.hash+'</a>',
            true
          );
        } else {
          setStatus("Minted. If image doesn’t show, set tokenURI manually as contract owner on Polygonscan.");
        }
      }catch(err){
        setStatus("Minted. Could not set tokenURI automatically; use manual method on Polygonscan (owner).");
      }

    }catch(err){
      setStatus("❌ " + (err?.message || String(err)));
    }
  };
}
</script>
</body>
</html>
