<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DreamPlay – Membership NFT Claim</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;margin:0;background:#0b0f14;color:#e7edf3}
    .wrap{max-width:820px;margin:32px auto;padding:16px}
    .card{background:#121821;border:1px solid #1b2531;border-radius:14px;padding:20px;margin-bottom:16px}
    h1{margin:0 0 8px;font-size:24px}
    label{display:block;font-size:12px;color:#9ab0c4;margin:12px 0 6px}
    input,button,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #263244;background:#0d131a;color:#e7edf3}
    button{cursor:pointer;background:#0ea5e9;border-color:#0ea5e9;font-weight:700}
    .small{font-size:12px;color:#9ab0c4}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .ok{color:#22c55e}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    a{color:#93c5fd}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
  </style>
  <!-- Ethers v6 UMD -->
  <script defer src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Claim your Membership NFT</h1>
      <p class="small">Paste your <strong>purchase transaction hash</strong> from Polygonscan, connect the same wallet used to buy, fill your details, then mint.</p>

      <div class="row" style="margin-top:10px">
        <button id="btnConnect" style="flex:0 0 200px">Connect Wallet</button>
        <div id="acct" class="small mono"></div>
      </div>

      <label for="txHash">Purchase transaction hash</label>
      <input id="txHash" placeholder="0x… (your purchase tx hash on Polygon)" />

      <div class="grid">
        <div>
          <label for="f1">Field 1</label><input id="f1" placeholder="…" />
        </div>
        <div>
          <label for="f2">Field 2</label><input id="f2" placeholder="…" />
        </div>
        <div>
          <label for="f3">Field 3</label><input id="f3" placeholder="…" />
        </div>
        <div>
          <label for="f4">Field 4</label><input id="f4" placeholder="…" />
        </div>
        <div>
          <label for="f5">Field 5</label><input id="f5" placeholder="…" />
        </div>
        <div>
          <label for="f6">Field 6</label><input id="f6" placeholder="…" />
        </div>
        <div>
          <label for="f7">Field 7</label><input id="f7" placeholder="…" />
        </div>
        <div>
          <label for="f8">Field 8</label><input id="f8" placeholder="…" />
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="btnVerify">Verify & Claim NFT</button>
      </div>

      <div id="status" class="small" style="margin-top:10px"></div>

      <div class="small" style="margin-top:10px">
        Store: <a target="_blank" rel="noreferrer" class="mono" href="https://polygonscan.com/address/0x94617689Ca2F39C5418Bd3CF143445d5533af489">0x9461…f489</a> ·
        Membership: <a target="_blank" rel="noreferrer" class="mono" href="https://polygonscan.com/address/0x9d9605e6924bA7a0411dd381e0eE8000da129316">0x9d96…9316</a>
      </div>
    </div>
  </div>

<script>
"use strict";
(async function(){
  // Addresses
  const STORE_ADDR      = "0x94617689Ca2F39C5418Bd3CF143445d5533af489";
  const MEMBERSHIP_ADDR = "0x9d9605e6924bA7a0411dd381e0eE8000da129316";

  // ABIs
  const STORE_ABI = [
    "event Purchased(address indexed buyer,uint256 indexed skuId,uint256 priceUSDC,address sponsor,address[8] uplines,uint256[8] levelPaid,uint256 storehouseAmt,uint256 wipAmt)"
  ];
  // NOTE: your contract's claim is (skuId, fieldsHash) — no signatures.
  const MEMBERSHIP_ABI = [
    "function name() view returns (string)",
    "function claim(uint256 skuId, bytes32 fieldsHash) returns (uint256)"
  ];

  const $ = (id)=>document.getElementById(id);
  let provider, signer, acct;

  function setStatus(msg, ok=false){
    $('status').innerHTML = ok ? '<span class="ok">'+msg+'</span>' : msg;
  }

  $('btnConnect').onclick = async ()=>{
    try{
      if (!window.ethereum){ setStatus("Please install MetaMask"); return; }
      provider = new ethers.BrowserProvider(window.ethereum, 'any');
      await provider.send('eth_requestAccounts',[]);
      signer = await provider.getSigner();
      acct = await signer.getAddress();
      $('acct').textContent = 'Connected: ' + acct;
      try {
        const net = await provider.getNetwork();
        if (Number(net.chainId) !== 137) setStatus("Note: you are not on Polygon mainnet (chainId " + net.chainId + "). Switch to Polygon.");
      } catch {}
    }catch(err){ setStatus('❌ ' + (err?.message || String(err))); }
  };

  async function getSkuIdFromTx(txHash){
    const r = await provider.getTransactionReceipt(txHash);
    if (!r || r.status !== 1) throw new Error("Invalid or failed transaction");
    const iface = new ethers.Interface(STORE_ABI);
    for (const lg of r.logs || []) {
      if ((lg.address || '').toLowerCase() !== STORE_ADDR.toLowerCase()) continue;
      try {
        const ev = iface.parseLog(lg);
        if (ev && ev.name === 'Purchased') {
          return { buyer: ev.args.buyer, skuId: Number(ev.args.skuId) };
        }
      } catch {}
    }
    throw new Error("No Purchased event found for this tx");
  }

  function fieldsHashFromInputs(){
    const vals = [];
    for (let i=1;i<=8;i++){
      const v = (document.getElementById('f'+i).value || '').trim();
      vals.push(v);
    }
    // Hash the 8 fields together (keccak256 over a joined UTF-8 string).
    // Any stable method works because the contract only stores the hash.
    const joined = vals.join('|'); // delimiter to avoid ambiguity
    const bytes  = ethers.toUtf8Bytes(joined);
    return ethers.keccak256(bytes); // bytes32
  }

  $('btnVerify').onclick = async ()=>{
    try{
      if (!signer) await $('btnConnect').onclick();
      const txHash = $('txHash').value.trim();
      if (!txHash || !txHash.startsWith('0x') || txHash.length < 66) throw new Error('Enter a valid transaction hash');

      setStatus("Checking purchase…");
      const { buyer, skuId } = await getSkuIdFromTx(txHash);
      if (buyer.toLowerCase() !== acct.toLowerCase()) {
        setStatus(`❌ Wallet mismatch. Tx buyer is ${buyer}, you connected ${acct}.`); return;
      }
      if (!Number.isFinite(skuId) || skuId < 0) throw new Error('Bad skuId in event');

      const fieldsHash = fieldsHashFromInputs();
      setStatus(`Verified purchase for skuId ${skuId}. Minting…`);

      const membership = new ethers.Contract(MEMBERSHIP_ADDR, MEMBERSHIP_ABI, signer);
      // Optional: read & display name (nice UX)
      try {
        const nm = await membership.name();
        console.log('Contract name:', nm);
      } catch {}

      const tx = await membership.claim(skuId, fieldsHash);
      const rcpt = await tx.wait();
      setStatus(
        'Minted! <a class="mono" target="_blank" rel="noreferrer" href="https://polygonscan.com/tx/'+rcpt.hash+'">'+rcpt.hash+'</a>',
        true
      );
    }catch(err){
      setStatus("❌ " + (err?.message || String(err)));
    }
  };
})();
</script>
</body>
</html>
